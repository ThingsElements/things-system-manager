<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../things-ajax/things-ajax.html">
<link rel="import" href="../things-grid/things-resource-grid.html">
<link rel="import" href="../things-detail/things-resource-detail-tab-view-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../../elements/things-layout-view/things-layout-hera.html">

<dom-module id="things-system-scene-auth">
	<template>
		<style>
			:host{
				display:block;
				@apply(--layout-vertical);
			}
			things-layout-hera {
				@apply(--layout-flex);
			}
			things-resource-grid {
				@apply(--layout-flex);
			}
		</style>

		<things-ajax
			id="scene-group-ajax"
			resource-url="user_scene_groups/update_multiple"
			resource-action="update_multiple">
		</things-ajax>

		<things-ajax
			auto
			id="user-groups-ajax"
			resource-url="user_scene_groups/user_groups/:id"
			resource-id="[[resourceId]]"
			resource-adtion="index"
			last-response="{{groupList}}">
		</things-ajax>

		<things-layout-hera
			left-content-title="[[leftContentTitle]]"
			right-content-title="[[rightContentTitle]]">

			<things-resource-grid
				left
				id="scene-group-grid"
				config="[[gridConfig]]"
				model="[[gridModel]]"
				columns="[[gridColumns]]"
				data="[[sceneGroups]]"
				fixed-column-count="0"
				buttons="[[sceneGroupButton]]">
			</things-resource-grid>

			<things-resource-grid
				right
				id="play-group-grid"
				config="[[gridConfig]]"
				model="[[gridModel]]"
				columns="[[gridColumns]]"
				data="[[playGroups]]"
				fixed-column-count="0"
				buttons="[[playGroupButton]]">
			</things-resource-grid>

		</things-layout-hera>
	</template>
	<script>
		Polymer({
			is: 'things-system-scene-auth',

			behaviors: [
				Things.ResourceDetailTabViewBahavior,
				Things.MsgBoxBehavior
			],

			properties: {
				leftContentTitle: {
					type: String,
					value: function() {
						return Things.DataGlobal.t('menu.SceneGroup');
					}
				},

				rightContentTitle: {
					type: String,
					value: function() {
						return Things.DataGlobal.t('label.play_group');
					}
				},

				gridConfig: {
					type: Object,
					value: function() {
						return {
							displayOptions: {
								fitStyle: 'evenFill'
							}
						}
					}
				},

				gridModel: {
					type: Array,
					value: function() {
						return [{
							fieldName: 'id'
						}, {
							fieldName: 'scene_group_id'
						}, {
							fieldName: 'category'
						}, {
							fieldName: 'scene_group_name'
						}, {
							fieldName: 'scene_group_desc'
						}, {
							fieldName: 'auth'
						}]
					}
				},

				gridColumns: {
					type: Array,
					value: function() {
						return [{
							fieldName: 'id',
							width: 0
						}, {
							fieldName: 'scene_group_id',
							width: 0
						}, { 
							fieldName: 'category',
							width: 0
						},{
							fieldName: 'scene_group_name',
							name: 'scene_group_name',
							width: 150,
							editable: false,
							header: {
								text: Things.DataGlobal.t('label.group')
							}
						},{
							fieldName: 'scene_group_desc',
							name: 'scene_group_desc',
							width: 150,
							editable: false,
							header: {
								text: Things.DataGlobal.t('label.description')
							}
						}, {
							fieldName: 'auth',
							name: 'auth',
							width: 80,
							editable: false,
							header: {
								text: Things.DataGlobal.t('label.auth')
							},
							renderer: {
								type: "check",
								editable: true,
								threeStates: false,
								trueValues: "true",
								falseValues: "false"
							},
							nullable: true
						}]
					}
				},

				groupList: {
					type: Array,
					observer: 'groupListChanged'
				},

				sceneGroups: {
					type: Array,
					value: []
				},

				playGroups: {
					type: Array,
					value: []
				},

				sceneGroupButton: {
					type: Array,
					value: function() {
						return [{
							id: 'save-btn', text: 'save'
						}]
					}
				},

				playGroupButton: {
					type: Array,
					value: function() {
						return [{
							id: 'save-btn', text: 'save'
						}]
					}
				}
			},

			listeners: {
				'scene-group-grid.things-grid-handle-save': 'groupSaveHandeler',
				'play-group-grid.things-grid-handle-save': 'groupSaveHandeler',
				'scene-group-ajax.things-ajax-response': 'saveAjaxResponsed'
			},

			/**
			 * user_scene_group의 호출에 대한 response가 도착하면
			 * sceneGroups와 playGroups를 초기화하여 각기 그리드에 출력
			 */
			groupListChanged: function(groupList) {
				var sceneGroups = [];
				var playGroups = [];
				groupList.forEach(function(group) {
					if(group.category == 'SCENE') {
						sceneGroups.push(group);
					} else if (group.category == 'PLAY') {
						playGroups.push(group);
					}
				});

				this.sceneGroups = sceneGroups;
				this.playGroups = playGroups;
			},

			/**
			 * 변경된 그룹 정보를 저장하기 위한 handeler
			 */
			groupSaveHandeler: function(event) {
				event.preventDefault();
				var writeData = event.target.writeData;
				var tempArray = [];

				writeData.forEach(function(data) {
					if(this.checkDataChanged(data)) {
						if(data.auth == 'true') {
							var tempObj = {
								account_id: this.resourceId,
								group_type: data.category,
								scene_group_id: data.scene_group_id,
								cud_flag_: 'c'
							};

							tempArray.push(tempObj);
						} else if (data.auth == 'false') {
							var tempObj = {
								id: data.id,
								cud_flag_: 'd'
							};

							tempArray.push(tempObj);
						}
					}
				}.bind(this));

				/**
				 * 변경된 데이터가 있으면 ajax 호출 없을시 메시지 출력
				 */
				if(tempArray.length > 0) {
					var sceneGroupSaveAjax = this.$['scene-group-ajax'];
					sceneGroupSaveAjax.body = tempArray;
					sceneGroupSaveAjax.generateRequest();
				} else {
					this.openInfoMsg({ title : Things.DataGlobal.t('title.info'), text : Things.DataGlobal.t('text.NOTHING_CHANGED'), type : 'info' });
				}
			},

			/**
			 * 데이터가 변경되었는지 확인함
			 */
			checkDataChanged: function(data) {
				var result = true;
				this.groupList.forEach(function(item) {
					if(item.scene_group_id == data.scene_group_id) {
						if(item.auth == true && data.auth == 'true') {
							result = false;
						} else if (item.auth == false && data.auth == 'false') {
							result = false;
						}
					}
				});

				return result;
			},

			/**
			 * save ajax response시 그리드를 재구성하기 위해 ajax 호출
			 */
			saveAjaxResponsed: function(event) {
				this.$['user-groups-ajax'].generateRequest();
			}
		})
	</script>
</dom-module>